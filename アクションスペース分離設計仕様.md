# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹åˆ†é›¢è¨­è¨ˆä»•æ§˜

## ğŸ¯ è¨­è¨ˆæ–¹é‡

**å®Œå…¨åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®å›ºæœ‰åŠ¹æœã¨ç´¯ç©ç‰©ç®¡ç†ã‚’å®Œå…¨ã«åˆ†é›¢ã—ã€ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

### åŸå‰‡
1. **å˜ä¸€è²¬ä»»**: ActionSpaceã¯å›ºæœ‰åŠ¹æœã®ã¿ã‚’æ‹…å½“
2. **ç‹¬ç«‹æ€§**: ç´¯ç©ç‰©ç®¡ç†ã¯ç‹¬ç«‹ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã§å‡¦ç†
3. **æ‹¡å¼µæ€§**: æ–°ã—ã„ç´¯ç©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„åŠ¹æœã‚’å®¹æ˜“ã«è¿½åŠ å¯èƒ½
4. **ä¿å®ˆæ€§**: å„ã‚·ã‚¹ãƒ†ãƒ ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°å¯èƒ½

## ğŸ—ï¸ æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. ActionSpaceï¼ˆå›ºæœ‰åŠ¹æœã®ã¿ï¼‰

```csharp
public class ActionSpace : MonoBehaviour
{
    [Header("åŸºæœ¬æƒ…å ±")]
    public string actionId;           // ç´¯ç©ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã™ã‚‹ä¸€æ„ID
    public string actionName;
    public ActionType actionType;
    public bool allowMultipleWorkers = false;
    public int maxWorkers = 1;
    
    [Header("å›ºæœ‰åŠ¹æœã®ã¿")]
    public List<ActionEffect> coreEffects = new List<ActionEffect>();
    public List<ResourceRequirement> resourceRequirements = new List<ResourceRequirement>();
    public int cardsToDraw = 0;
    public int victoryPoints = 0;
    
    // ç´¯ç©ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å‚ç…§ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    private AccumulatedItemManager accumulatedItemManager;
    
    void Start()
    {
        // ä¸€æ„IDã®è‡ªå‹•ç”Ÿæˆ
        if (string.IsNullOrEmpty(actionId))
        {
            actionId = $"{actionName}_{GetInstanceID()}";
        }
        
        accumulatedItemManager = FindObjectOfType<AccumulatedItemManager>();
    }
    
    public bool PlaceWorker(Worker worker)
    {
        if (!CanPlaceWorker()) return false;
        
        // 1. å›ºæœ‰åŠ¹æœã‚’å®Ÿè¡Œ
        ExecuteCoreEffects(worker.owner);
        
        // 2. ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ã—ã¦æ¶ˆè²»
        var accumulatedItems = accumulatedItemManager.ConsumeAccumulatedItems(actionId);
        foreach (var item in accumulatedItems)
        {
            worker.owner.AddResource(item.Key, item.Value);
            Debug.Log($"ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ç²å¾—: {item.Key} x{item.Value}");
        }
        
        // 3. ãƒ¯ãƒ¼ã‚«ãƒ¼é…ç½®å‡¦ç†
        placedWorkers.Add(worker);
        worker.SetActionSpace(this);
        worker.transform.position = GetWorkerPosition(placedWorkers.Count - 1);
        
        // 4. è·æ¥­åŠ¹æœã®ãƒˆãƒªã‚¬ãƒ¼
        worker.owner.OnActionExecuted(this);
        
        UpdateVisual();
        OnWorkerPlaced?.Invoke(worker);
        return true;
    }
    
    private void ExecuteCoreEffects(Player player)
    {
        // å›ºæœ‰åŠ¹æœã®ã¿ã‚’å®Ÿè¡Œï¼ˆç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã¯é–¢ä¸ã—ãªã„ï¼‰
        foreach (var effect in coreEffects)
        {
            effect.Execute(player);
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—åˆ¥ã®å‡¦ç†
        switch (actionType)
        {
            case ActionType.AddField:
                player.AddField();
                break;
            case ActionType.FamilyGrowth:
                player.GrowFamily();
                break;
            case ActionType.HouseExpansion:
                player.ExpandHouse(1, ResourceType.Wood);
                break;
            // ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—...
        }
        
        // å‹åˆ©ç‚¹ã®ä»˜ä¸
        if (victoryPoints > 0)
        {
            player.AddVictoryPoints(victoryPoints);
        }
    }
    
    // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã®ç¢ºèªï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
    public Dictionary<ResourceType, int> GetAccumulatedItems()
    {
        return accumulatedItemManager?.GetAccumulatedItems(actionId) ?? new Dictionary<ResourceType, int>();
    }
    
    public bool HasAccumulatedItems()
    {
        return GetAccumulatedItems().Count > 0;
    }
}
```

### 2. AccumulatedItemManagerï¼ˆç´¯ç©ç‰©ç®¡ç†ï¼‰

```csharp
public class AccumulatedItemManager : MonoBehaviour
{
    [Header("ç´¯ç©ãƒ«ãƒ¼ãƒ«è¨­å®š")]
    [SerializeField] private List<AccumulationRule> standardRules = new List<AccumulationRule>();
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹IDåˆ¥ã®ç´¯ç©ãƒ—ãƒ¼ãƒ«
    private Dictionary<string, AccumulatedItemPool> accumulatedPools = new Dictionary<string, AccumulatedItemPool>();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆ
    public System.Action<string, ResourceType, int> OnItemAccumulated;
    public System.Action<string, Dictionary<ResourceType, int>> OnItemsConsumed;
    
    void Start()
    {
        InitializeStandardRules();
    }
    
    private void InitializeStandardRules()
    {
        // æ¨™æº–çš„ãªç´¯ç©ãƒ«ãƒ¼ãƒ«
        standardRules.Add(new AccumulationRule("forest", ResourceType.Wood, 3));
        standardRules.Add(new AccumulationRule("clay_pit", ResourceType.Clay, 1));
        standardRules.Add(new AccumulationRule("reed_pond", ResourceType.Reed, 1));
        standardRules.Add(new AccumulationRule("fishing", ResourceType.Food, 1));
        standardRules.Add(new AccumulationRule("sheep_market", ResourceType.Sheep, 1));
        standardRules.Add(new AccumulationRule("boar_market", ResourceType.Boar, 1));
        standardRules.Add(new AccumulationRule("cattle_market", ResourceType.Cattle, 1));
    }
    
    /// <summary>
    /// ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
    /// </summary>
    public void AddAccumulatedItem(string actionSpaceId, ResourceType resourceType, int amount, string sourceId = "")
    {
        if (!accumulatedPools.ContainsKey(actionSpaceId))
        {
            accumulatedPools[actionSpaceId] = new AccumulatedItemPool(actionSpaceId);
        }
        
        accumulatedPools[actionSpaceId].AddItem(resourceType, amount, sourceId);
        OnItemAccumulated?.Invoke(actionSpaceId, resourceType, amount);
        
        Debug.Log($"ç´¯ç©è¿½åŠ : {actionSpaceId} ã« {resourceType} x{amount} (from: {sourceId})");
    }
    
    /// <summary>
    /// ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ï¼ˆæ¶ˆè²»ï¼‰
    /// </summary>
    public Dictionary<ResourceType, int> ConsumeAccumulatedItems(string actionSpaceId)
    {
        if (accumulatedPools.ContainsKey(actionSpaceId))
        {
            var items = accumulatedPools[actionSpaceId].ConsumeAll();
            OnItemsConsumed?.Invoke(actionSpaceId, items);
            return items;
        }
        return new Dictionary<ResourceType, int>();
    }
    
    /// <summary>
    /// ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç¢ºèªï¼ˆæ¶ˆè²»ã—ãªã„ï¼‰
    /// </summary>
    public Dictionary<ResourceType, int> GetAccumulatedItems(string actionSpaceId)
    {
        return accumulatedPools.ContainsKey(actionSpaceId) ? 
               accumulatedPools[actionSpaceId].GetItems() : 
               new Dictionary<ResourceType, int>();
    }
    
    /// <summary>
    /// æ¨™æº–çš„ãªç´¯ç©ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
    /// </summary>
    public void ApplyStandardAccumulation()
    {
        foreach (var rule in standardRules)
        {
            if (rule.isActive)
            {
                AddAccumulatedItem(rule.actionSpaceId, rule.resourceType, rule.amount, "standard_rule");
            }
        }
    }
    
    /// <summary>
    /// ç‰¹å®šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®ç´¯ç©ã‚’ã‚¯ãƒªã‚¢
    /// </summary>
    public void ClearAccumulatedItems(string actionSpaceId)
    {
        if (accumulatedPools.ContainsKey(actionSpaceId))
        {
            accumulatedPools[actionSpaceId].Clear();
        }
    }
    
    /// <summary>
    /// å…¨ã¦ã®ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªã‚¢
    /// </summary>
    public void ClearAllAccumulatedItems()
    {
        accumulatedPools.Clear();
    }
    
    /// <summary>
    /// ç´¯ç©å±¥æ­´ã‚’å–å¾—
    /// </summary>
    public List<AccumulationEntry> GetAccumulationHistory(string actionSpaceId)
    {
        return accumulatedPools.ContainsKey(actionSpaceId) ? 
               accumulatedPools[actionSpaceId].GetHistory() : 
               new List<AccumulationEntry>();
    }
}
```

### 3. AccumulatedItemPoolï¼ˆç´¯ç©ãƒ—ãƒ¼ãƒ«ï¼‰

```csharp
[System.Serializable]
public class AccumulatedItemPool
{
    public string actionSpaceId;
    private Dictionary<ResourceType, int> items = new Dictionary<ResourceType, int>();
    private List<AccumulationEntry> history = new List<AccumulationEntry>();
    
    public AccumulatedItemPool(string actionSpaceId)
    {
        this.actionSpaceId = actionSpaceId;
    }
    
    public void AddItem(ResourceType resourceType, int amount, string sourceId = "")
    {
        if (!items.ContainsKey(resourceType))
            items[resourceType] = 0;
        
        items[resourceType] += amount;
        
        // å±¥æ­´è¨˜éŒ²
        history.Add(new AccumulationEntry
        {
            resourceType = resourceType,
            amount = amount,
            sourceId = sourceId,
            timestamp = System.DateTime.Now,
            actionType = AccumulationAction.Add
        });
    }
    
    public Dictionary<ResourceType, int> ConsumeAll()
    {
        var result = new Dictionary<ResourceType, int>(items);
        
        // æ¶ˆè²»å±¥æ­´ã‚’è¨˜éŒ²
        foreach (var item in result)
        {
            history.Add(new AccumulationEntry
            {
                resourceType = item.Key,
                amount = -item.Value,
                sourceId = "consumed",
                timestamp = System.DateTime.Now,
                actionType = AccumulationAction.Consume
            });
        }
        
        items.Clear();
        return result;
    }
    
    public Dictionary<ResourceType, int> GetItems()
    {
        return new Dictionary<ResourceType, int>(items);
    }
    
    public void Clear()
    {
        items.Clear();
        history.Clear();
    }
    
    public List<AccumulationEntry> GetHistory()
    {
        return new List<AccumulationEntry>(history);
    }
}
```

### 4. ã‚µãƒãƒ¼ãƒˆã‚¯ãƒ©ã‚¹

```csharp
[System.Serializable]
public class AccumulationRule
{
    public string actionSpaceId;
    public ResourceType resourceType;
    public int amount;
    public bool isActive = true;
    public string description;
    
    public AccumulationRule(string actionSpaceId, ResourceType resourceType, int amount)
    {
        this.actionSpaceId = actionSpaceId;
        this.resourceType = resourceType;
        this.amount = amount;
    }
}

[System.Serializable]
public class AccumulationEntry
{
    public ResourceType resourceType;
    public int amount;
    public string sourceId;
    public System.DateTime timestamp;
    public AccumulationAction actionType;
}

public enum AccumulationAction
{
    Add,
    Consume,
    Clear
}

[System.Serializable]
public class ActionEffect
{
    public ActionEffectType effectType;
    public ResourceType resourceType;
    public int amount;
    public string description;
    
    public void Execute(Player player)
    {
        switch (effectType)
        {
            case ActionEffectType.GainResource:
                player.AddResource(resourceType, amount);
                break;
            case ActionEffectType.SpendResource:
                player.SpendResource(resourceType, amount);
                break;
            // ä»–ã®åŠ¹æœã‚¿ã‚¤ãƒ—...
        }
    }
}

public enum ActionEffectType
{
    GainResource,
    SpendResource,
    DrawCard,
    AddField,
    // ä»–ã®åŠ¹æœã‚¿ã‚¤ãƒ—...
}
```

### 5. æ”¹å–„ã•ã‚ŒãŸActionSpaceManager

```csharp
public class ActionSpaceManager : MonoBehaviour
{
    [Header("æ®µéšçš„è§£æ”¾è¨­å®š")]
    [SerializeField] private List<ActionSpacePhase> phases = new List<ActionSpacePhase>();
    
    private AccumulatedItemManager accumulatedItemManager;
    private List<ActionSpace> allActionSpaces = new List<ActionSpace>();
    private HashSet<ActionSpace> activeActionSpaces = new HashSet<ActionSpace>();
    
    void Start()
    {
        accumulatedItemManager = FindObjectOfType<AccumulatedItemManager>();
        InitializeActionSpaces();
        SetupPhases();
    }
    
    public void ActivateActionSpacesForRound(int round)
    {
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®è§£æ”¾
        foreach (ActionSpacePhase phase in phases)
        {
            if (phase.startRound == round)
            {
                foreach (string spaceName in phase.actionSpaceNames)
                {
                    ActionSpace space = allActionSpaces.FirstOrDefault(s => s.actionName == spaceName);
                    if (space != null && !activeActionSpaces.Contains(space))
                    {
                        space.gameObject.SetActive(true);
                        activeActionSpaces.Add(space);
                        Debug.Log($"ğŸ“ {spaceName} ã‚’è§£æ”¾ã—ã¾ã—ãŸ");
                    }
                }
            }
        }
        
        // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã®è£œå……ï¼ˆå›ºæœ‰åŠ¹æœã¨ã¯å®Œå…¨ã«åˆ†é›¢ï¼‰
        ReplenishAccumulatedItems();
    }
    
    private void ReplenishAccumulatedItems()
    {
        // ç´¯ç©ã‚·ã‚¹ãƒ†ãƒ ã«æ¨™æº–çš„ãªç´¯ç©ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
        accumulatedItemManager.ApplyStandardAccumulation();
        Debug.Log("ğŸ’° ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’è£œå……ã—ã¾ã—ãŸ");
    }
    
    // å›ºæœ‰åŠ¹æœã®ç®¡ç†ã¯ä¸è¦ï¼ˆå„ActionSpaceãŒç‹¬ç«‹ã—ã¦å‡¦ç†ï¼‰
}
```

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥

### ãƒ•ã‚§ãƒ¼ã‚º1: æ–°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
1. `AccumulatedItemManager`ã®å®Ÿè£…
2. `AccumulatedItemPool`ã®å®Ÿè£…
3. ã‚µãƒãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ã®è¿½åŠ 

### ãƒ•ã‚§ãƒ¼ã‚º2: ActionSpaceã®æ”¹ä¿®
1. `resourceGain`ã®æ®µéšçš„å‰Šé™¤
2. å›ºæœ‰åŠ¹æœã®`ActionEffect`ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ç§»è¡Œ
3. ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ APIã®çµ±åˆ

### ãƒ•ã‚§ãƒ¼ã‚º3: ActionSpaceManagerã®æ”¹ä¿®
1. ç´¯ç©å‡¦ç†ã®`AccumulatedItemManager`ã¸ã®ç§»è¡Œ
2. `ReplenishActionSpace`ã®å‰Šé™¤
3. æ–°ã—ã„`ReplenishAccumulatedItems`ã®å®Ÿè£…

### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼
1. å„ã‚·ã‚¹ãƒ†ãƒ ã®ç‹¬ç«‹ã—ãŸãƒ†ã‚¹ãƒˆ
2. çµ±åˆãƒ†ã‚¹ãƒˆ
3. æ—¢å­˜æ©Ÿèƒ½ã®äº’æ›æ€§ç¢ºèª

## ğŸ¯ åˆ†é›¢å¾Œã®ãƒ¡ãƒªãƒƒãƒˆ

### 1. è²¬ä»»ã®æ˜ç¢ºåŒ–
- **ActionSpace**: å›ºæœ‰åŠ¹æœã®ã¿ã«é›†ä¸­
- **AccumulatedItemManager**: ç´¯ç©ç‰©ç®¡ç†ã®ã¿ã«é›†ä¸­

### 2. æŸ”è»Ÿæ€§ã®å‘ä¸Š
- ã‚«ãƒ¼ãƒ‰åŠ¹æœã§ä»»æ„ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«ä»»æ„ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç´¯ç©å¯èƒ½
- æ–°ã—ã„ç´¯ç©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ ãŒå®¹æ˜“

### 3. ä¿å®ˆæ€§ã®å‘ä¸Š
- å„ã‚·ã‚¹ãƒ†ãƒ ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“
- å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ãŒé™å®šçš„

### 4. æ‹¡å¼µæ€§ã®å‘ä¸Š
- æ–°ã—ã„å›ºæœ‰åŠ¹æœã®è¿½åŠ ãŒå®¹æ˜“
- è¤‡é›‘ãªç´¯ç©ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…ãŒå¯èƒ½
- UIè¡¨ç¤ºã®æ”¹å–„ãŒå®¹æ˜“

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å¿…é ˆå®Ÿè£…
- [ ] AccumulatedItemManager
- [ ] AccumulatedItemPool
- [ ] ActionEffect ã‚·ã‚¹ãƒ†ãƒ 
- [ ] AccumulationRule ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ActionSpace ã®æ”¹ä¿®
- [ ] ActionSpaceManager ã®æ”¹ä¿®

### æ¨å¥¨å®Ÿè£…
- [ ] ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã®è¦–è¦šåŒ–
- [ ] å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ„ãƒ¼ãƒ«
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®å›ºæœ‰åŠ¹æœã¨ç´¯ç©ç‰©ç®¡ç†ãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã€ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹æŸ”è»Ÿã§ä¿å®ˆæ€§ã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚