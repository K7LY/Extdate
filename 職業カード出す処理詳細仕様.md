# 職業カード出す処理詳細仕様

## 概要
職業カードを出す処理の詳細仕様を定義します。進歩カードシステムと同様の構造を持ちますが、職業カード特有のコストと条件を考慮した設計となります。

## 現在の実装状況

### 既存の実装
- `OccupationCard.cs`: 職業カードの基本クラス（実装済み）
- `OccupationManager.cs`: 職業カード管理クラス（プレースホルダー実装）
- `EnhancedOccupationCard.cs`: 拡張職業カードクラス（実装済み）

### 進歩カードシステムとの比較
- 進歩カード: `ImprovementManager.cs`で包括的な管理システム実装済み
- 職業カード: 管理システムがプレースホルダー実装のみ

## 職業カードの特徴

### 進歩カードとの相違点

#### 1. コスト体系
- **進歩カード**: 主にリソース（木材、粘土、石材）コスト
- **職業カード**: 食料コスト + 特殊条件

#### 2. プレイ条件
- **進歩カード**: リソースと前提カード
- **職業カード**: 家族数、部屋数、特定のリソース保有

#### 3. 効果発動
- **進歩カード**: 主に即座効果と継続効果
- **職業カード**: 特定タイミングでのトリガー効果

## 職業カードシステム設計

### 1. 基本アーキテクチャ

```
OccupationManager (包括的管理)
├── OccupationCard (基本カード)
├── EnhancedOccupationCard (拡張カード)
├── OccupationActionConfiguration (アクション設定)
└── OccupationPlaySystem (プレイシステム)
```

### 2. 職業カードのコスト設定

#### 食料コスト体系
```csharp
public class OccupationCostData
{
    public int foodCost;           // 基本食料コスト
    public int additionalFoodCost; // 追加食料コスト（既存職業数による）
    public Dictionary<ResourceType, int> resourceCosts; // その他リソースコスト
}
```

#### コスト計算ロジック
- 基本食料コスト: カード固有の値
- 追加食料コスト: 既存職業数 × 追加コスト係数
- 最終コスト = 基本食料コスト + （既存職業数 × 追加食料コスト）

### 3. プレイ条件

#### 家族数条件
```csharp
public class OccupationPlayCondition
{
    public int minimumFamilyMembers;  // 最小家族数
    public int minimumRooms;          // 最小部屋数
    public List<ResourceType> requiredResources; // 必要リソース
    public List<string> prerequisiteOccupations; // 前提職業
}
```

#### 特殊条件
- 特定の進歩カードの保有
- 特定の設備の保有
- 特定のリソース量の保有

### 4. 職業カードプレイフロー

#### 基本フロー
1. **アクション選択**: プレイヤーが職業カードアクションを選択
2. **条件チェック**: プレイ可能な職業カードをフィルタリング
3. **カード選択**: プレイヤーが職業カードを選択
4. **コスト確認**: 食料コストと追加コストを表示
5. **支払い**: コストを支払い
6. **効果発動**: 職業カード効果を適用
7. **登録**: プレイヤーの職業リストに追加

#### 詳細処理フロー
```
PlayOccupation(Player player, int maxCount)
├── GetAvailableOccupations(player)
│   ├── CheckFamilyConditions(player, card)
│   ├── CheckResourceConditions(player, card)
│   └── CheckPrerequisiteConditions(player, card)
├── CalculateOccupationCost(player, card)
│   ├── GetBaseFoodCost(card)
│   ├── GetAdditionalFoodCost(player.occupations.Count)
│   └── GetResourceCosts(card)
├── ShowOccupationSelection(player, availableCards)
├── ExecuteSelectedOccupation(player, selectedCard)
│   ├── PayOccupationCost(player, card)
│   ├── ApplyOccupationEffects(player, card)
│   └── RegisterOccupation(player, card)
└── TriggerOccupationEvents(player, card)
```

## 実装詳細

### 1. 拡張 OccupationManager

#### 主要メソッド
```csharp
public class EnhancedOccupationManager : MonoBehaviour
{
    // 職業カードプレイ
    public void PlayOccupation(Player player, int maxCount = 1)
    
    // 利用可能職業取得
    public List<EnhancedOccupationCard> GetAvailableOccupations(Player player)
    
    // プレイ可能性チェック
    public bool CanPlayOccupation(Player player, EnhancedOccupationCard card)
    
    // コスト計算
    public OccupationCostData CalculateOccupationCost(Player player, EnhancedOccupationCard card)
    
    // 職業カード実行
    public bool ExecuteSelectedOccupation(Player player, EnhancedOccupationCard card)
}
```

#### 詳細実装方針
- 進歩カードシステムと同様の構造
- 職業カード特有のコスト計算
- 条件チェックの強化

### 2. 職業カードアクション設定

#### OccupationActionConfiguration
```csharp
[System.Serializable]
public class OccupationActionSetup
{
    public string actionName;
    public string actionId;
    public OccupationActionType actionType;
    public int maxCardsPerUse;
    public bool allowPlayerChoice;
    public List<ActionEffect> effects;
    public List<OccupationActionCondition> conditions;
}
```

#### アクション種別
- **StandardOccupation**: 通常の職業カード
- **SpecialOccupation**: 特殊な職業カード
- **FamilyGrowthOccupation**: 家族成長+職業
- **ResourceOccupation**: リソース獲得+職業

### 3. 職業カードのトリガーシステム

#### 既存トリガーの活用
- `OccupationTrigger`列挙型を使用
- 新しい収穫フェーズ用トリガーを活用
- `CardTriggerManager`との連携

#### トリガー処理フロー
```csharp
public void TriggerOccupationEffects(Player player, OccupationTrigger trigger, object context)
{
    foreach (var occupation in player.GetOccupations())
    {
        if (occupation.trigger == trigger)
        {
            occupation.TriggerEffect(player, trigger, context);
        }
    }
}
```

## UI・UXの考慮

### 1. 職業カード選択画面

#### 表示情報
- カード名と説明
- 食料コスト（基本 + 追加）
- その他リソースコスト
- プレイ条件（家族数、部屋数等）
- プレイ可能/不可能の状態

#### 選択フロー
1. 利用可能職業カードの一覧表示
2. 各カードのコスト情報表示
3. プレイ不可能な理由の表示
4. 選択確認とコスト支払い

### 2. コスト表示システム

#### 動的コスト計算
```
職業カード「農夫」
基本食料コスト: 2
追加食料コスト: 1 × 既存職業数(1) = 1
合計食料コスト: 3
その他コスト: なし
```

## テストシナリオ

### 1. 基本機能テスト
- 職業カードの選択と実行
- コスト計算の正確性
- 条件チェックの動作

### 2. エラーハンドリング
- 食料不足時の処理
- 条件不満時の処理
- カード選択キャンセル時の処理

### 3. 統合テスト
- 進歩カードシステムとの連携
- 収穫フェーズでのトリガー発動
- ゲーム全体での動作確認

## 実装優先度

### Phase 1: 基本システム
1. EnhancedOccupationManagerの実装
2. 職業カードコスト計算システム
3. 基本的なプレイフロー

### Phase 2: 拡張機能
1. 職業カードアクション設定
2. 高度な条件チェック
3. UI統合

### Phase 3: 統合・最適化
1. 既存システムとの統合
2. パフォーマンス最適化
3. 包括的テスト

## 実装ファイル構成

### 新規作成ファイル
- `EnhancedOccupationManager.cs`
- `OccupationActionConfiguration.cs`
- `OccupationCostCalculator.cs`
- `OccupationPlaySystem.cs`

### 修正ファイル
- `OccupationManager.cs` (既存プレースホルダーから拡張)
- `Player.cs` (職業関連メソッドの追加)
- `GameManager.cs` (職業システム統合)

## 技術仕様

### 依存関係
- Unity 2022.3+
- 既存のCardSystemとの連携
- GameManagerとの統合

### パフォーマンス考慮
- 職業カード検索の最適化
- メモリ使用量の最小化
- UI更新の効率化

## 今後の拡張性

### 将来的な拡張
- 職業カードの組み合わせ効果
- 高度な職業カード（特殊職業）
- 職業カードのバランス調整システム

### 設定可能要素
- 職業カードデータの外部設定
- コスト計算式の調整
- 条件設定の柔軟性

---

この仕様書に基づき、職業カード出す処理の詳細実装を行います。進歩カードシステムの成熟した設計を参考に、職業カード特有の要求事項を満たす包括的なシステムを構築します。