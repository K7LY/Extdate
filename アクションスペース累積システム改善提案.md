# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ç´¯ç©ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ææ¡ˆ

## ğŸ¯ å•é¡Œã®åˆ†æ

### ç¾åœ¨ã®å•é¡Œç‚¹
ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®**æœ¬æ¥ã®åŠ¹æœ**ã¨**ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ **ãŒæ··åœ¨ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼š

1. **å¯†çµåˆ**: `ActionSpace.resourceGain`ã§æœ¬æ¥ã®åŠ¹æœã¨ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ãŒæ··åœ¨
2. **æŸ”è»Ÿæ€§ã®ä¸è¶³**: ã‚«ãƒ¼ãƒ‰åŠ¹æœã§ç„¡é–¢ä¿‚ãªã‚¢ã‚¤ãƒ†ãƒ ãŒç´¯ç©ã™ã‚‹å ´åˆã«å¯¾å¿œå›°é›£
3. **ç®¡ç†ã®è¤‡é›‘æ€§**: ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ãƒªã‚»ãƒƒãƒˆãŒè¤‡é›‘

### å…·ä½“çš„ãªå•é¡Œä¾‹
```csharp
// ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ã“ã®ã‚ˆã†ãªçŠ¶æ³ã«å¯¾å¿œã§ããªã„
// ä¾‹ï¼šã€Œæ£®ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆæœ¬æ¥ã¯æœ¨æã‚’æä¾›ï¼‰
// - ã‚«ãƒ¼ãƒ‰åŠ¹æœã§é£Ÿæ–™ãŒ2å€‹ç´¯ç©
// - åˆ¥ã®ã‚«ãƒ¼ãƒ‰åŠ¹æœã§çŸ³ãŒ1å€‹ç´¯ç©
// - æœ¬æ¥ã®æœ¨æåŠ¹æœã¨ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ãŒæ··åœ¨
```

## ğŸ”§ æ”¹å–„ææ¡ˆï¼šç´¯ç©ã‚·ã‚¹ãƒ†ãƒ ã®åˆ†é›¢

### è¨­è¨ˆåŸå‰‡
1. **å˜ä¸€è²¬ä»»ã®åŸå‰‡**: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã¯æœ¬æ¥ã®åŠ¹æœã®ã¿ã‚’æ‹…å½“
2. **é–‹æ”¾é–‰é–ã®åŸå‰‡**: æ–°ã—ã„ç´¯ç©ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã‚„ã™ã„è¨­è¨ˆ
3. **ä¾å­˜é–¢ä¿‚ã®é€†è»¢**: ç´¯ç©ã‚·ã‚¹ãƒ†ãƒ ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«ä¾å­˜ã—ãªã„

### æ–°ã—ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### 1. AccumulatedItemManagerï¼ˆç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†ï¼‰
```csharp
public class AccumulatedItemManager : MonoBehaviour
{
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹IDã”ã¨ã®ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ 
    private Dictionary<string, AccumulatedItemPool> accumulatedItems = new Dictionary<string, AccumulatedItemPool>();
    
    // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
    public void AddAccumulatedItem(string actionSpaceId, ResourceType resourceType, int amount, string sourceId = "")
    {
        if (!accumulatedItems.ContainsKey(actionSpaceId))
        {
            accumulatedItems[actionSpaceId] = new AccumulatedItemPool();
        }
        
        accumulatedItems[actionSpaceId].AddItem(resourceType, amount, sourceId);
    }
    
    // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—ï¼ˆæ¶ˆè²»ï¼‰
    public Dictionary<ResourceType, int> ConsumeAccumulatedItems(string actionSpaceId)
    {
        if (accumulatedItems.ContainsKey(actionSpaceId))
        {
            var items = accumulatedItems[actionSpaceId].GetAllItems();
            accumulatedItems[actionSpaceId].Clear();
            return items;
        }
        return new Dictionary<ResourceType, int>();
    }
    
    // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç¢ºèªï¼ˆæ¶ˆè²»ã—ãªã„ï¼‰
    public Dictionary<ResourceType, int> GetAccumulatedItems(string actionSpaceId)
    {
        if (accumulatedItems.ContainsKey(actionSpaceId))
        {
            return accumulatedItems[actionSpaceId].GetAllItems();
        }
        return new Dictionary<ResourceType, int>();
    }
}
```

#### 2. AccumulatedItemPoolï¼ˆç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ãƒ—ãƒ¼ãƒ«ï¼‰
```csharp
[System.Serializable]
public class AccumulatedItemPool
{
    private Dictionary<ResourceType, int> items = new Dictionary<ResourceType, int>();
    private List<AccumulatedItemEntry> itemHistory = new List<AccumulatedItemEntry>();
    
    public void AddItem(ResourceType resourceType, int amount, string sourceId = "")
    {
        if (!items.ContainsKey(resourceType))
            items[resourceType] = 0;
        
        items[resourceType] += amount;
        
        // å±¥æ­´ã‚’è¨˜éŒ²
        itemHistory.Add(new AccumulatedItemEntry
        {
            resourceType = resourceType,
            amount = amount,
            sourceId = sourceId,
            timestamp = System.DateTime.Now
        });
    }
    
    public Dictionary<ResourceType, int> GetAllItems()
    {
        return new Dictionary<ResourceType, int>(items);
    }
    
    public void Clear()
    {
        items.Clear();
        itemHistory.Clear();
    }
    
    public List<AccumulatedItemEntry> GetHistory()
    {
        return new List<AccumulatedItemEntry>(itemHistory);
    }
}

[System.Serializable]
public class AccumulatedItemEntry
{
    public ResourceType resourceType;
    public int amount;
    public string sourceId;
    public System.DateTime timestamp;
}
```

#### 3. æ”¹å–„ã•ã‚ŒãŸActionSpace
```csharp
public class ActionSpace : MonoBehaviour
{
    [Header("åŸºæœ¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±")]
    public string actionId;  // ä¸€æ„ã®ID
    public string actionName;
    public ActionType actionType;
    
    // æœ¬æ¥ã®åŠ¹æœã®ã¿ã‚’å®šç¾©ï¼ˆç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã¯é™¤å¤–ï¼‰
    [Header("å›ºæœ‰åŠ¹æœ")]
    public List<ActionEffect> coreEffects = new List<ActionEffect>();
    
    // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†ã¸ã®å‚ç…§
    private AccumulatedItemManager accumulatedItemManager;
    
    void Start()
    {
        accumulatedItemManager = FindObjectOfType<AccumulatedItemManager>();
    }
    
    public bool PlaceWorker(Worker worker)
    {
        if (!CanPlaceWorker()) return false;
        
        // 1. æœ¬æ¥ã®åŠ¹æœã‚’å®Ÿè¡Œ
        ExecuteCoreAction(worker.owner);
        
        // 2. ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
        var accumulatedItems = accumulatedItemManager.ConsumeAccumulatedItems(actionId);
        foreach (var item in accumulatedItems)
        {
            worker.owner.AddResource(item.Key, item.Value);
        }
        
        // 3. ãƒ¯ãƒ¼ã‚«ãƒ¼é…ç½®å‡¦ç†
        placedWorkers.Add(worker);
        worker.SetActionSpace(this);
        
        return true;
    }
    
    private void ExecuteCoreAction(Player player)
    {
        // æœ¬æ¥ã®åŠ¹æœã®ã¿ã‚’å®Ÿè¡Œ
        switch (actionType)
        {
            case ActionType.AddField:
                player.AddField();
                break;
            case ActionType.FamilyGrowth:
                player.GrowFamily();
                break;
            // å›ºæœ‰åŠ¹æœã®ã¿ã€ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã¯é–¢ä¸ã—ãªã„
        }
    }
}
```

#### 4. æ”¹å–„ã•ã‚ŒãŸActionSpaceManager
```csharp
public class ActionSpaceManager : MonoBehaviour
{
    private AccumulatedItemManager accumulatedItemManager;
    
    void Start()
    {
        accumulatedItemManager = FindObjectOfType<AccumulatedItemManager>();
    }
    
    // æ¨™æº–çš„ãªç´¯ç©ãƒ«ãƒ¼ãƒ«
    public void ReplenishActionSpaces()
    {
        // æ¨™æº–çš„ãªç´¯ç©ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
        accumulatedItemManager.AddAccumulatedItem("forest", ResourceType.Wood, 3, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("clay_pit", ResourceType.Clay, 1, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("reed_pond", ResourceType.Reed, 1, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("fishing", ResourceType.Food, 1, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("sheep_market", ResourceType.Sheep, 1, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("boar_market", ResourceType.Boar, 1, "standard_rule");
        accumulatedItemManager.AddAccumulatedItem("cattle_market", ResourceType.Cattle, 1, "standard_rule");
    }
}
```

#### 5. ã‚«ãƒ¼ãƒ‰åŠ¹æœã§ã®ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
```csharp
// ã‚«ãƒ¼ãƒ‰åŠ¹æœä¾‹ï¼šä»»æ„ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç´¯ç©
public class CardEffect_AddAccumulatedItem : CardEffect
{
    public string targetActionSpaceId;
    public ResourceType resourceType;
    public int amount;
    
    public override void Execute(Player player)
    {
        var accumulatedItemManager = FindObjectOfType<AccumulatedItemManager>();
        accumulatedItemManager.AddAccumulatedItem(targetActionSpaceId, resourceType, amount, "card_effect");
        
        Debug.Log($"ã‚«ãƒ¼ãƒ‰åŠ¹æœã«ã‚ˆã‚Š{targetActionSpaceId}ã«{resourceType}ãŒ{amount}å€‹ç´¯ç©ã•ã‚Œã¾ã—ãŸ");
    }
}

// ä½¿ç”¨ä¾‹
// ã€Œæ£®ã®æµã¿ã€ã‚«ãƒ¼ãƒ‰ï¼šæ£®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«é£Ÿæ–™2å€‹ã‚’ç´¯ç©
var forestBlessingCard = new Card();
forestBlessingCard.effects.Add(new CardEffect_AddAccumulatedItem
{
    targetActionSpaceId = "forest",
    resourceType = ResourceType.Food,
    amount = 2
});
```

## ğŸ¨ è¦–è¦šåŒ–ã‚·ã‚¹ãƒ†ãƒ 

### AccumulatedItemVisualizer
```csharp
public class AccumulatedItemVisualizer : MonoBehaviour
{
    [SerializeField] private GameObject itemIconPrefab;
    [SerializeField] private Transform itemContainer;
    
    public void UpdateVisual(Dictionary<ResourceType, int> accumulatedItems)
    {
        // æ—¢å­˜ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªã‚¢
        foreach (Transform child in itemContainer)
        {
            Destroy(child.gameObject);
        }
        
        // ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤º
        foreach (var item in accumulatedItems)
        {
            var iconObj = Instantiate(itemIconPrefab, itemContainer);
            var icon = iconObj.GetComponent<ResourceIcon>();
            icon.SetResource(item.Key, item.Value);
        }
    }
}
```

## ğŸ“Š ä½¿ç”¨ä¾‹ã¨ãƒ¡ãƒªãƒƒãƒˆ

### ä½¿ç”¨ä¾‹1ï¼šæ¨™æº–çš„ãªç´¯ç©
```csharp
// æ¯ãƒ©ã‚¦ãƒ³ãƒ‰ã€æ£®ã«æœ¨æ3å€‹ãŒç´¯ç©
accumulatedItemManager.AddAccumulatedItem("forest", ResourceType.Wood, 3, "standard_rule");
```

### ä½¿ç”¨ä¾‹2ï¼šã‚«ãƒ¼ãƒ‰åŠ¹æœã«ã‚ˆã‚‹ç´¯ç©
```csharp
// ã€Œè±Šä½œã®å­£ç¯€ã€ã‚«ãƒ¼ãƒ‰ï¼šå…¨ã¦ã®ç•‘ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«ç©€ç‰©1å€‹ã‚’ç´¯ç©
foreach (var fieldActionSpace in fieldActionSpaces)
{
    accumulatedItemManager.AddAccumulatedItem(fieldActionSpace.actionId, ResourceType.Grain, 1, "harvest_season_card");
}
```

### ä½¿ç”¨ä¾‹3ï¼šè¤‡é›‘ãªç´¯ç©ãƒ‘ã‚¿ãƒ¼ãƒ³
```csharp
// ã€Œå¸‚å ´ã®æ´»æ³ã€ã‚«ãƒ¼ãƒ‰ï¼šå‹•ç‰©å¸‚å ´ã«é£Ÿæ–™ã‚‚ç´¯ç©
accumulatedItemManager.AddAccumulatedItem("sheep_market", ResourceType.Food, 1, "market_boom_card");
accumulatedItemManager.AddAccumulatedItem("boar_market", ResourceType.Food, 1, "market_boom_card");
accumulatedItemManager.AddAccumulatedItem("cattle_market", ResourceType.Food, 1, "market_boom_card");
```

## ğŸš€ å®Ÿè£…ã®ãƒ¡ãƒªãƒƒãƒˆ

### 1. æŸ”è»Ÿæ€§ã®å‘ä¸Š
- ã‚«ãƒ¼ãƒ‰åŠ¹æœã§ä»»æ„ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã«ä»»æ„ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç´¯ç©å¯èƒ½
- ç´¯ç©ãƒ«ãƒ¼ãƒ«ã®å‹•çš„ãªå¤‰æ›´ãŒå®¹æ˜“
- æ–°ã—ã„ç´¯ç©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¿½åŠ ãŒç°¡å˜

### 2. ä¿å®ˆæ€§ã®å‘ä¸Š
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®æœ¬æ¥ã®åŠ¹æœã¨ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ãŒåˆ†é›¢
- å˜ä¸€è²¬ä»»ã®åŸå‰‡ã«å¾“ã£ãŸè¨­è¨ˆ
- ãƒ‡ãƒãƒƒã‚°ã¨ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“

### 3. æ‹¡å¼µæ€§ã®å‘ä¸Š
- æ–°ã—ã„ç´¯ç©ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ãŒå®¹æ˜“
- å±¥æ­´ç®¡ç†ã«ã‚ˆã‚‹è©³ç´°ãªåˆ†æãŒå¯èƒ½
- UIè¡¨ç¤ºã®æ”¹å–„ãŒå®¹æ˜“

### 4. ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®è‡ªç”±åº¦å‘ä¸Š
- æœ¬æ¥ã®åŠ¹æœã¨ç„¡é–¢ä¿‚ãªã‚¢ã‚¤ãƒ†ãƒ ã®ç´¯ç©ãŒå¯èƒ½
- è¤‡é›‘ãªã‚«ãƒ¼ãƒ‰åŠ¹æœã®å®Ÿè£…ãŒå®¹æ˜“
- ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ãŒç°¡å˜

## ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

### ãƒ•ã‚§ãƒ¼ã‚º1ï¼šæ–°ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
1. `AccumulatedItemManager`ã®å®Ÿè£…
2. `AccumulatedItemPool`ã®å®Ÿè£…
3. æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ä½µç”¨é–‹å§‹

### ãƒ•ã‚§ãƒ¼ã‚º2ï¼šæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œ
1. `ActionSpace`ã‹ã‚‰ç´¯ç©é–¢é€£ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
2. `ActionSpaceManager`ã®ç´¯ç©å‡¦ç†ã‚’æ–°ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œ
3. ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼

### ãƒ•ã‚§ãƒ¼ã‚º3ï¼šæ‹¡å¼µæ©Ÿèƒ½ã®è¿½åŠ 
1. ã‚«ãƒ¼ãƒ‰åŠ¹æœã§ã®ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
2. è¦–è¦šåŒ–ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
3. é«˜åº¦ãªç´¯ç©ãƒ«ãƒ¼ãƒ«ã®å®Ÿè£…

## ğŸ“ çµè«–

ã“ã®æ”¹å–„ã«ã‚ˆã‚Šã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã®æœ¬æ¥ã®åŠ¹æœã¨ç´¯ç©ã‚¢ã‚¤ãƒ†ãƒ ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã€ã‚«ãƒ¼ãƒ‰åŠ¹æœãªã©ã§å‹•çš„ã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç´¯ç©ã§ãã‚‹æŸ”è»Ÿãªã‚·ã‚¹ãƒ†ãƒ ãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§ã‚‚å¤§å¹…ã«å‘ä¸Šã—ã€ã‚ˆã‚Šè¤‡é›‘ãªã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ã«ã‚‚å¯¾å¿œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚